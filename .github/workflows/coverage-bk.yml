name: Java CI with Maven, JaCoCo and Coverage Enforcement

on:
  pull_request:
    branches: [ master ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Java 23
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '23'

    - name: Cache Maven dependencies
      uses: actions/cache@v3
      with:
        path: ~/.m2/repository
        key: ${{ runner.os }}-maven-${{ hashFiles('backend/pom.xml') }}
        restore-keys: |
          ${{ runner.os }}-maven-

    - name: Debug: List Directory Structure
      run: |
        echo "Current directory:"
        pwd  # This will print the current directory
        echo "Listing files in the current directory:"
        ls -l  # This will list the files to verify if backend folder exists

    - name: Build with Maven
      run: |
        cd backend  # Change to the backend directory
        pwd  # Check if we are in the right directory
        ls -l  # List the files in backend/ to verify pom.xml exists
        mvn clean install --no-transfer-progress -e -X

    - name: Run Tests with Coverage
      run: |
        cd backend  # Change to the backend directory
        pwd  # Check if we are in the right directory
        ls -l  # List the files in backend/
        mvn test jacoco:report -e -X

    - name: Check Coverage
      id: coverage
      run: |
        cd backend  # Change to the backend directory
        pwd  # Check if we are in the right directory
        ls -l  # List the files in backend/
        coverage=$(mvn jacoco:report -e -X | grep -oP 'Coverage: \K[0-9]+')
        echo "Coverage is: $coverage%"
        if [ "$coverage" -lt 85 ]; then
          echo "‚ùå Coverage is below 85%. Failing build."
          exit 1
        else
          echo "‚úÖ Coverage is sufficient."

    - name: Comment Coverage on PR
      uses: marocchino/sticky-pull-request-comment@v2
      with:
        header: coverage
        message: |
          ### üß™ Code Coverage Report
          - Coverage: **${{ steps.coverage.outputs.coverage }}%**
          - Required: **85%**
